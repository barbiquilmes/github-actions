name: Run and Upload to S3
on:
  push:
    tags:
      - 'v*'
    paths-ignore:
      - '.github/workflows/*'
  workflow_dispatch:
jobs:
    test:
      runs-on: ubuntu-latest
      steps:
        - name: Extract tag name
          id: tag
          run: echo ${{ toJson(github) }}
          #uses: actions/github-script@0.2.0
          #with:
          #  github-token: ${{ secrets.GITHUB_TOKEN }}
          #  script: |
          #    return context.payload.ref.replace(/\/refs\/tags\//, '');
        #- name: Echo
        #  run: echo ${{ steps.tag.outputs.result }}
    build:
        runs-on: ubuntu-latest
        steps:
          - name: Get code
            uses: actions/checkout@v3
          - name: Set up Python 3.10
            uses: actions/setup-python@v4
            with:
              python-version: 3.10.12
          - name: Output path
            run: echo pwd
          - name: Output contents
            run: ls
          - name: Run script
            id: run-foo-output
            run: |
              python ./src/foo_output.py
          - name: Save data
            uses: actions/upload-artifact@v3
            with:
              name: data-files
              path: data
    upload:
        needs: build
        runs-on: ubuntu-latest
        steps:
          - name: Get code
            uses: actions/checkout@v3
          - name: Get build artifacts
            uses: actions/download-artifact@v3
            with:
              name: data-files
              path: ./data
          - name: Output contents
            run: ls
          - name: Upload s3
            id: upload-s3
            uses: ./.github/actions/s3-docker
            env:
              AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
              AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            with:
              bucket: my-github-actions
              data_folder: ./data
              # bucket_region: us-east-2
